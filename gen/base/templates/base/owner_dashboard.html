{% extends "base/base.html" %}

{% block title %}
Админ-панель | {{ site_brand }}
{% endblock %}

{% block content %}
<section class="page-shell">
    <div class="page-header">
        <h1 class="page-title">Админ-панель</h1>
        <p class="page-subtitle">Доступ только для пользователей с флагом администратора в БД.</p>
    </div>

    <div class="grid-cards" style="margin-bottom: 18px;">
        <article class="order-card"><h3>Пользователи</h3><p>{{ stats.users }}</p></article>
        <article class="order-card"><h3>Новые заявки</h3><p>{{ stats.orders_new }}</p></article>
        <article class="order-card"><h3>Новые предзаказы</h3><p>{{ stats.preorders_new }}</p></article>
        <article class="order-card"><h3>Статьи на модерации</h3><p>{{ stats.submissions_pending }}</p></article>
        <article class="order-card"><h3>Всего статей</h3><p>{{ stats.articles_total }}</p></article>
    </div>

    <div class="page-header">
        <h2 class="page-title" style="font-size:26px;">Администраторы по email (БД)</h2>
        <p class="page-subtitle">Добавляйте/отключайте доступ по email. Именно этот список управляет входом в админ-панель.</p>
    </div>

    <form method="post" action="{% url 'owner_admin_grant' %}" class="form-shell" style="margin-bottom: 16px;">
        {% csrf_token %}
        <div class="form-row">
            <div class="form-field">
                <label class="form-label" for="{{ admin_form.email.id_for_label }}">{{ admin_form.email.label }}</label>
                {{ admin_form.email }}
                {{ admin_form.email.errors }}
            </div>
            <div class="form-field">
                <label class="form-label" for="{{ admin_form.note.id_for_label }}">{{ admin_form.note.label }}</label>
                {{ admin_form.note }}
                {{ admin_form.note.errors }}
            </div>
        </div>
        <div>
            <button type="submit" class="btn-main">Выдать/обновить админ-доступ</button>
        </div>
    </form>

    <div class="owner-table-wrap">
        <table class="owner-table">
            <thead>
                <tr>
                    <th>Email</th>
                    <th>Статус</th>
                    <th>Комментарий</th>
                    <th>Кто выдал</th>
                    <th>Действие</th>
                </tr>
            </thead>
            <tbody>
                {% for access in admin_accesses %}
                    <tr>
                        <td>{{ access.email }}</td>
                        <td>{% if access.is_active %}Активен{% else %}Отключен{% endif %}</td>
                        <td>{{ access.note|default:"-" }}</td>
                        <td>{{ access.granted_by.email|default:"-" }}</td>
                        <td>
                            {% if access.is_active %}
                                <form method="post" action="{% url 'owner_admin_revoke' access.id %}" style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn-link">Отключить</button>
                                </form>
                            {% else %}
                                <form method="post" action="{% url 'owner_admin_activate' access.id %}" style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn-main">Включить</button>
                                </form>
                            {% endif %}
                        </td>
                    </tr>
                {% empty %}
                    <tr><td colspan="5">Список администраторов пуст.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="page-header" style="margin-top:20px;">
        <h2 class="page-title" style="font-size:26px;">Telegram управление</h2>
    </div>
    <div class="quick-info">
        <p><strong>Бот:</strong> {% if telegram_bot_username %}@{{ telegram_bot_username }}{% else %}не указан{% endif %}</p>
        <p><strong>Админ chat id:</strong> {{ telegram_admin_chat_ids|join:", "|default:"не указаны" }}</p>
        <p><strong>Команды бота:</strong> /help, /orders, /order &lt;id&gt;, /set_order &lt;id&gt; &lt;new|in_progress|done&gt;, /preorders, /set_preorder &lt;id&gt; &lt;new|in_progress|done&gt;, /admins, /grant &lt;email&gt;, /revoke &lt;email&gt;</p>
    </div>

    <div class="page-header" style="margin-top:20px;">
        <h2 class="page-title" style="font-size:26px;">Заявки на статьи</h2>
    </div>

    <div class="grid-cards">
        {% for submission in submissions %}
            <article class="order-card">
                <h3>{{ submission.title }}</h3>
                <p><strong>Автор:</strong> {{ submission.user.email|default:"аноним" }}</p>
                <p><strong>Статус:</strong> {{ submission.get_status_display }}</p>
                <p>{{ submission.summary|default:"Без краткого описания"|truncatechars:200 }}</p>
                <p><strong>Изображений:</strong> {{ submission.images.count }}</p>

                {% if submission.status == "pending" %}
                    <form method="post" action="{% url 'owner_submission_approve' submission.id %}" class="form-shell" style="margin-top: 8px;">
                        {% csrf_token %}
                        {{ review_form.review_comment }}
                        <button type="submit" class="btn-main">Одобрить и опубликовать</button>
                    </form>

                    <form method="post" action="{% url 'owner_submission_reject' submission.id %}" class="form-shell" style="margin-top: 8px;">
                        {% csrf_token %}
                        {{ review_form.review_comment }}
                        <button type="submit" class="btn-link">Отклонить</button>
                    </form>
                {% elif submission.approved_article %}
                    <p><a class="btn-link" href="{% url 'article_detail' submission.approved_article.slug %}">Открыть опубликованную статью</a></p>
                {% endif %}
            </article>
        {% empty %}
            <article class="order-card"><h3>Нет заявок на модерацию</h3></article>
        {% endfor %}
    </div>

    <div class="page-header" style="margin-top:20px;">
        <h2 class="page-title" style="font-size:26px;">Пользователи</h2>
    </div>
    <div class="owner-table-wrap">
        <table class="owner-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Email</th>
                    <th>Логин</th>
                    <th>Имя</th>
                    <th>Дата регистрации</th>
                </tr>
            </thead>
            <tbody>
                {% for u in users %}
                    <tr>
                        <td>{{ u.id }}</td>
                        <td>{{ u.email }}</td>
                        <td>{{ u.username }}</td>
                        <td>{{ u.get_full_name|default:"-" }}</td>
                        <td>{{ u.date_joined|date:"d.m.Y H:i" }}</td>
                    </tr>
                {% empty %}
                    <tr><td colspan="5">Пользователей нет</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="page-header" style="margin-top:20px;">
        <h2 class="page-title" style="font-size:26px;">Заявки на услуги</h2>
    </div>
    <div class="owner-table-wrap">
        <table class="owner-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Клиент</th>
                    <th>Телефон</th>
                    <th>Статья</th>
                    <th>Статус</th>
                    <th>Дата</th>
                    <th>Управление</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                    <tr>
                        <td>{{ order.id }}</td>
                        <td>{{ order.name }}</td>
                        <td>{{ order.phone }}</td>
                        <td>{{ order.article.title|default:"-" }}</td>
                        <td>{{ order.get_status_display }}</td>
                        <td>{{ order.created_at|date:"d.m.Y H:i" }}</td>
                        <td>
                            <form method="post" action="{% url 'owner_order_status_update' order.id %}" style="display:flex; gap:8px; align-items:center;">
                                {% csrf_token %}
                                <select name="status" class="inputf1" style="max-width: 170px;">
                                    {% for key, label in order_status_choices %}
                                        <option value="{{ key }}" {% if order.status == key %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                                <button type="submit" class="btn-main">Сохранить</button>
                            </form>
                        </td>
                    </tr>
                {% empty %}
                    <tr><td colspan="7">Заявок нет</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="page-header" style="margin-top:20px;">
        <h2 class="page-title" style="font-size:26px;">Предзаказы магазина</h2>
    </div>
    <div class="owner-table-wrap">
        <table class="owner-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Пользователь</th>
                    <th>Категория</th>
                    <th>Товар/Запрос</th>
                    <th>Количество</th>
                    <th>Статус</th>
                    <th>Управление</th>
                </tr>
            </thead>
            <tbody>
                {% for preorder in preorders %}
                    <tr>
                        <td>{{ preorder.id }}</td>
                        <td>{{ preorder.user.email|default:"-" }}</td>
                        <td>{{ preorder.category.name|default:"-" }}</td>
                        <td>{{ preorder.product.name|default:preorder.desired_item|default:"-" }}</td>
                        <td>{{ preorder.quantity }}</td>
                        <td>{{ preorder.get_status_display }}</td>
                        <td>
                            <form method="post" action="{% url 'owner_preorder_status_update' preorder.id %}" style="display:flex; gap:8px; align-items:center;">
                                {% csrf_token %}
                                <select name="status" class="inputf1" style="max-width: 170px;">
                                    {% for key, label in preorder_status_choices %}
                                        <option value="{{ key }}" {% if preorder.status == key %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                                <button type="submit" class="btn-main">Сохранить</button>
                            </form>
                        </td>
                    </tr>
                {% empty %}
                    <tr><td colspan="7">Предзаказов нет</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% endblock %}
